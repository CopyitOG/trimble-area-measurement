<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surface Coordinate Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 16px;
        }

        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 16px;
        }

        h1 {
            font-size: 18px;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: #0078d4;
            color: white;
        }

        .btn:hover:not(:disabled) {
            background: #005a9e;
        }

        .btn.active {
            background: #28a745;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            margin-top: 12px;
            padding: 10px;
            border-radius: 4px;
            font-size: 13px;
        }

        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 3px solid #1976d2;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 3px solid #2e7d32;
        }

        .status.warning {
            background: #fff3e0;
            color: #e65100;
            border-left: 3px solid #ff9800;
        }

        .coordinates {
            margin-top: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            display: none;
        }

        .coordinates.visible {
            display: block;
        }

        .coord-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-family: monospace;
            font-size: 14px;
        }

        .coord-label {
            font-weight: bold;
            color: #666;
        }

        .coord-value {
            color: #0078d4;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>
            <div class="icon">XYZ</div> Surface Coordinates
        </h1>
        <button id="toggle-btn" class="btn" disabled>
            <span id="btn-text">Connecting...</span>
        </button>
        <div id="status" class="status info">
            Connecting to Trimble Connect...
        </div>
        <div id="coordinates" class="coordinates">
            <div class="coord-row">
                <span class="coord-label">X:</span>
                <span class="coord-value" id="coord-x">--</span>
            </div>
            <div class="coord-row">
                <span class="coord-label">Y:</span>
                <span class="coord-value" id="coord-y">--</span>
            </div>
            <div class="coord-row">
                <span class="coord-label">Z:</span>
                <span class="coord-value" id="coord-z">--</span>
            </div>
        </div>
    </div>

    <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
    <script>
        (async function () {
            let API = null;
            let isActive = false;
            const toggleBtn = document.getElementById('toggle-btn');
            const btnText = document.getElementById('btn-text');
            const statusDiv = document.getElementById('status');
            const coordinatesDiv = document.getElementById('coordinates');
            const coordX = document.getElementById('coord-x');
            const coordY = document.getElementById('coord-y');
            const coordZ = document.getElementById('coord-z');

            // Connect to Workspace API
            try {
                console.log('[Coord Tool] Connecting...');
                API = await TrimbleConnectWorkspace.connect(window.parent, handleEvent);

                console.log('[Coord Tool] Connected!', API);
                updateStatus('Connected! Click "Activate Tool" to start.', 'success');
                toggleBtn.disabled = false;
                btnText.textContent = 'Activate Tool';

            } catch (error) {
                console.error('[Coord Tool] Connection error:', error);
                updateStatus('Connection failed: ' + error.message, 'warning');
            }

            function handleEvent(event, data) {
                console.log('[Coord Tool] Event:', event, data);

                // Look for pick events
                if (event === 'pick' && data && data.position) {
                    displayCoordinates(data.position);
                }
                // Selection events might have position data
                else if (event === 'selection' && data) {
                    if (data.position) {
                        displayCoordinates(data.position);
                    } else if (data.objects && data.objects[0] && data.objects[0].position) {
                        displayCoordinates(data.objects[0].position);
                    }
                }
                // Any event with Vector3 position
                else if (data && data.position && data.position.x !== undefined) {
                    displayCoordinates(data.position);
                }
            }

            toggleBtn.addEventListener('click', toggle);

            async function toggle() {
                isActive ? deactivate() : await activate();
            }

            async function activate() {
                isActive = true;
                toggleBtn.classList.add('active');
                btnText.textContent = 'Tool Active âœ“';
                coordinatesDiv.classList.add('visible');

                try {
                    // Try to activate a picking tool in the viewer
                    if (API && API.viewer && API.viewer.activateTool) {
                        await API.viewer.activateTool('reset'); // Reset to default
                        console.log('[Coord Tool] Default tool activated');
                    }

                    updateStatus('Tool active - click on model surfaces to see coordinates', 'success');

                    // Also listen for selection changes
                    if (API && API.viewer && API.viewer.getSelection) {
                        monitorSelection();
                    }

                } catch (error) {
                    console.error('[Coord Tool] Activation error:', error);
                    updateStatus('Tool active - waiting for picks...', 'warning');
                }
            }

            async function monitorSelection() {
                // Periodically check for selection changes
                if (!isActive) return;

                try {
                    const selection = await API.viewer.getSelection();
                    if (selection && selection.objectRuntimeIds && selection.objectRuntimeIds.length > 0) {
                        console.log('[Coord Tool] Selection:', selection);

                        // Try to get object properties with position
                        const props = await API.viewer.getObjectProperties(selection.objectRuntimeIds);
                        if (props && props[0] && props[0].position) {
                            displayCoordinates(props[0].position);
                        }
                    }
                } catch (error) {
                    console.log('[Coord Tool] Selection check:', error.message);
                }

                setTimeout(monitorSelection, 500);
            }

            function deactivate() {
                isActive = false;
                toggleBtn.classList.remove('active');
                btnText.textContent = 'Activate Tool';
                coordinatesDiv.classList.remove('visible');
                updateStatus('Tool deactivated', 'info');
            }

            function displayCoordinates(position) {
                // Position is Vector3 with x, y, z in meters
                console.log('[Coord Tool] Position:', position);

                // Convert to mm for display (like Trimble's tool)
                const x = (position.x * 1000).toFixed(0);
                const y = (position.y * 1000).toFixed(0);
                const z = (position.z * 1000).toFixed(0);

                coordX.textContent = `${x} mm`;
                coordY.textContent = `${y} mm`;
                coordZ.textContent = `${z} mm`;

                coordinatesDiv.classList.add('visible');
            }

            function updateStatus(message, type) {
                statusDiv.className = 'status ' + type;
                statusDiv.textContent = message;
            }
        })();
    </script>
</body>

</html>